<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aavaaz - Live Voice Call</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Arial; background: #1a1a1a; color: white; }
.call-container { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.call-header { text-align: center; margin-bottom: 30px; }
.call-header h1 { font-size: 32px; margin-bottom: 10px; }
.call-status { font-size: 18px; opacity: 0.9; }
.call-timer { font-size: 24px; margin: 20px 0; font-weight: bold; font-family: 'Courier New'; }
.call-info { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
.waveform { width: 300px; height: 60px; background: rgba(0,0,0,0.2); border-radius: 10px; margin: 20px 0; display: none; align-items: center; justify-content: center; gap: 4px; }
.bar { width: 4px; height: 30px; background: white; border-radius: 2px; animation: wave 0.6s ease-in-out infinite; }
@keyframes wave { 0%, 100% { height: 20px; } 50% { height: 50px; } }
.conversation-box { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; margin-bottom: 30px; max-height: 300px; overflow-y: auto; }
.message { margin-bottom: 15px; padding: 12px 15px; border-radius: 10px; word-wrap: break-word; }
.message.user { background: #667eea; text-align: right; margin-left: 20px; }
.message.grok { background: rgba(255,255,255,0.2); text-align: left; margin-right: 20px; border-left: 4px solid #4CAF50; }
.message-label { font-size: 12px; opacity: 0.7; margin-bottom: 5px; }
.controls { display: flex; gap: 15px; align-items: center; }
.btn-call { background: #4CAF50; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.btn-call:hover { background: #45a049; transform: scale(1.05); }
.btn-call.active { background: #ff4757; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,71,87,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,71,87,0); } }
.btn-end { background: #ff4757; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.btn-end:hover { background: #ff3838; }
.status-indicator { width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; animation: blink 2s infinite; }
.status-indicator.recording { background: #ff4757; }
@keyframes blink { 0%, 49%, 100% { opacity: 1; } 50%, 99% { opacity: 0.3; } }
.setup-screen { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.hidden { display: none !important; }
</style>
</head>
<body>
<div class="call-container">
  <!-- Setup Screen -->
  <div id="setupScreen" class="setup-screen">
    <h1>Welcome to Aavaaz</h1>
    <p style="font-size: 18px; margin-bottom: 20px;">Live Voice Conversation with Grok AI</p>
    <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 15px; text-align: center;">
      <label style="font-size: 16px; margin-bottom: 15px; display: block;">Your Story/Context:</label>
      <textarea id="storyContext" placeholder="Tell us about your story so Grok understands better..." style="width: 100%; padding: 15px; border-radius: 8px; border: none; font-family: inherit; min-height: 120px; color: #333;"></textarea>
      <button onclick="startCall()" class="btn-call" style="margin-top: 20px; width: 100%;">Start Call</button>
    </div>
  </div>

  <!-- Call Screen -->
  <div id="callScreen" class="hidden">
    <div class="call-header">
      <h1 id="callerName">Speaking with Grok</h1>
      <div class="call-status" id="callStatus">Call Active</div>
    </div>
    <div class="call-info">
      <div class="call-timer" id="callTimer">00:00</div>
      <div style="font-size: 14px; opacity: 0.8;">Press and hold to speak, release to listen</div>
    </div>
    <!-- Waveform Animation -->
    <div class="waveform" id="waveform" style="display: none;">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <!-- Conversation History -->
    <div class="conversation-box" id="conversationBox" style="text-align: center; color: rgba(255,255,255,0.5);">Conversation will appear here...</div>
    <!-- Controls -->
    <div class="controls">
      <div class="status-indicator" id="statusIndicator"></div>
      <button id="recordBtn" class="btn-call" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">ðŸŽ¤ Hold to Speak</button>
      <button class="btn-end" onclick="endCall()">End Call</button>
    </div>
  </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let callActive = false;
let callStartTime = 0;
let recordingInProgress = false;
const conversationHistory = [];
let userId = localStorage.getItem('aavaazUserId') || 'user_' + Date.now();
if (!localStorage.getItem('aavaazUserId')) {
  localStorage.setItem('aavaazUserId', userId);
}
const DEFAULT_VOICE_ID = 'EXAVITQu4vr4xnSDxMaL'; // ElevenLabs default voice

async function startCall() {
  const context = document.getElementById('storyContext').value;
  if (!context.trim()) {
    alert('Please enter your story context');
    return;
  }
  
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.onstart = () => {
      audioChunks = [];
      document.getElementById('waveform').style.display = 'flex';
      document.getElementById('statusIndicator').classList.add('recording');
      document.getElementById('callStatus').textContent = 'Recording...';
    };
    
    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      document.getElementById('waveform').style.display = 'none';
      document.getElementById('statusIndicator').classList.remove('recording');
      document.getElementById('callStatus').textContent = 'Processing...';
      
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      await sendAudioToGrok(audioBlob, context);
    };
    
    callActive = true;
    callStartTime = Date.now();
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('callScreen').classList.remove('hidden');
    startCallTimer();
    addMessage('System', 'Call started. Press and hold the microphone to speak.', 'grok');
  } catch (err) {
    alert('Microphone access denied: ' + err.message);
  }
}

function startRecording() {
  if (!callActive || recordingInProgress) return;
  recordingInProgress = true;
  audioChunks = [];
  mediaRecorder.start();
  document.getElementById('recordBtn').classList.add('active');
}

function stopRecording() {
  if (!recordingInProgress) return;
  recordingInProgress = false;
  mediaRecorder.stop();
  document.getElementById('recordBtn').classList.remove('active');
}

async function sendAudioToGrok(audioBlob, context) {
  try {
    // Convert blob to base64
    const reader = new FileReader();
    reader.onload = async () => {
      const audioBase64 = reader.result.split(',')[1];
      
      const requestBody = JSON.stringify({
        userId: userId,
        audioBase64: audioBase64,
        voiceId: DEFAULT_VOICE_ID,
        context: context,
        conversation: conversationHistory
      });
      
      addMessage('You', '[Voice message sent]', 'user');
      document.getElementById('callStatus').textContent = 'Grok is thinking...';
      
      const response = await fetch('/api/conversation-loop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: requestBody
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API error: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      
      if (data.grokResponse) {
        addMessage('Grok', data.grokResponse, 'grok');
        conversationHistory.push({ user: '[Voice]', grok: data.grokResponse });
        
        if (data.audioBase64) {
          playAudio(data.audioBase64);
        }
      }
      
      document.getElementById('callStatus').textContent = 'Your turn - Press and hold to speak';
    };
    reader.readAsDataURL(audioBlob);
  } catch (err) {
    addMessage('System', 'Error: ' + err.message, 'grok');
    document.getElementById('callStatus').textContent = 'Error - Try again';
  }
}

function addMessage(sender, text, type) {
  const box = document.getElementById('conversationBox');
  const msg = document.createElement('div');
  msg.className = 'message ' + type;
  msg.innerHTML = '<div class="message-label">' + sender + '</div>' + text;
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}

function startCallTimer() {
  setInterval(() => {
    if (callActive) {
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('callTimer').textContent = 
        String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }
  }, 1000);
}

function playAudio(audioBase64) {
  const audio = new Audio('data:audio/mpeg;base64,' + audioBase64);
  audio.play();
}

function endCall() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  callActive = false;
  document.getElementById('callScreen').classList.add('hidden');
  document.getElementById('setupScreen').classList.remove('hidden');
  document.getElementById('storyContext').value = '';
  conversationHistory.length = 0;
  document.getElementById('conversationBox').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5);">Conversation will appear here...</div>';
}
</script>
  
<!-- Cal.com Booking Integration -->
<div id="bookingScreen" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; color: white;">
    <h2 style="margin-bottom: 20px;">Book Your Voice Call</h2>
    <input type="email" id="bookingEmail" placeholder="Your Email" style="width: 100%; padding: 10px; margin: 10px 0; border: none; border-radius: 5px;">
    <input type="text" id="bookingName" placeholder="Your Name" style="width: 100%; padding: 10px; margin: 10px 0; border: none; border-radius: 5px;">
    <input type="datetime-local" id="bookingTime" style="width: 100%; padding: 10px; margin: 10px 0; border: none; border-radius: 5px;">
    <button onclick="proceedToPayment()" style="width: 100%; padding: 12px; margin: 20px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Proceed to Payment</button>
    <button onclick="goBack()" style="width: 100%; padding: 12px; background: #ff4757; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Back</button>
  </div>
</div>

<!-- Razorpay Payment Integration -->
<div id="paymentScreen" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; color: white;">
    <h2 style="margin-bottom: 20px;">Payment - â‚¹499</h2>
    <p style="margin-bottom: 20px; font-size: 14px; color: rgba(255,255,255,0.8);">30-minute voice call session with Grok AI</p>
    <button onclick="initiateRazorpayPayment()" style="width: 100%; padding: 12px; margin: 20px 0; background: #FF9800; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Pay with Razorpay</button>
    <button onclick="goBack()" style="width: 100%; padding: 12px; background: #ff4757; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Back</button>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
let currentBooking = {};

function proceedToPayment() {
  const email = document.getElementById('bookingEmail').value;
  const name = document.getElementById('bookingName').value;
  const time = document.getElementById('bookingTime').value;
  
  if (!email || !name || !time) {
    alert('Please fill all fields');
    return;
  }
  
  currentBooking = { email, name, time };
  document.getElementById('bookingScreen').classList.add('hidden');
  document.getElementById('paymentScreen').classList.remove('hidden');
}

async function initiateRazorpayPayment() {
  try {
    const response = await fetch('/api/payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount: 499,
        userId: 'user-' + Date.now(),
        email: currentBooking.email,
        description: 'Aavaaz Voice Call - 30 minutes'
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      const options = {
        key: data.key,
        amount: data.amount,
        currency: data.currency,
        order_id: data.orderId,
        handler: async function(response) {
          await verifyPayment(data.orderId, response.razorpay_payment_id, response.razorpay_signature);
        },
        prefill: {
          email: currentBooking.email,
          name: currentBooking.name
        }
      };
      
      const rzp = new Razorpay(options);
      rzp.open();
    }
  } catch (err) {
    alert('Payment error: ' + err.message);
  }
}

async function verifyPayment(orderId, paymentId, signature) {
  try {
    const response = await fetch('/api/payment-verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId, paymentId, signature })
    });
    
    const data = await response.json();
    if (data.success) {
      alert('Payment successful! Booking confirmed.');
      createCalendarBooking();
    }
  } catch (err) {
    alert('Verification error: ' + err.message);
  }
}

async function createCalendarBooking() {
  try {
    const response = await fetch('/api/booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: 'user-' + Date.now(),
        email: currentBooking.email,
        name: currentBooking.name,
        eventTypeId: 1,
        startTime: currentBooking.time,
        duration: 30
      })
    });
    
    const booking = await response.json();
    if (booking.success) {
      document.getElementById('paymentScreen').classList.add('hidden');
      document.getElementById('setupScreen').classList.remove('hidden');
      alert('Your booking is confirmed!');
    }
  } catch (err) {
    console.error('Booking error:', err);
  }
}

function goBack() {
  document.getElementById('bookingScreen').classList.add('hidden');
  document.getElementById('paymentScreen').classList.add('hidden');
  document.getElementById('setupScreen').classList.remove('hidden');
}

// Add booking button to setup screen
window.addEventListener('DOMContentLoaded', function() {
  const setupBtn = document.createElement('button');
  setupBtn.textContent = 'Book & Pay';
  setupBtn.style.cssText = 'background: #FF9800; color: white; border: none; padding: 12px 30px; border-radius: 25px; margin: 10px; font-size: 14px; cursor: pointer;';
  setupBtn.onclick = function() {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('bookingScreen').classList.remove('hidden');
  };
  const controls = document.querySelector('.setup-screen');
  if (controls) controls.parentNode.insertBefore(setupBtn, controls);
});
</script>
</body>
</html>
