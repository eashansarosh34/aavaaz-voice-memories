<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aavaaz - Live Voice Call</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Arial; background: #1a1a1a; color: white; }
.call-container { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.call-header { text-align: center; margin-bottom: 30px; }
.call-header h1 { font-size: 32px; margin-bottom: 10px; }
.call-status { font-size: 18px; opacity: 0.9; }
.call-timer { font-size: 24px; margin: 20px 0; font-weight: bold; font-family: 'Courier New'; }
.call-info { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
.waveform { width: 300px; height: 60px; background: rgba(0,0,0,0.2); border-radius: 10px; margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 4px; }
.bar { width: 4px; height: 30px; background: white; border-radius: 2px; animation: wave 0.6s ease-in-out infinite; }
.bar:nth-child(2) { animation-delay: 0.1s; }
.bar:nth-child(3) { animation-delay: 0.2s; }
.bar:nth-child(4) { animation-delay: 0.3s; }
.bar:nth-child(5) { animation-delay: 0.4s; }
@keyframes wave { 0%, 100% { height: 20px; } 50% { height: 50px; } }
.conversation-box { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; margin-bottom: 30px; max-height: 300px; overflow-y: auto; }
.message { margin-bottom: 15px; padding: 12px 15px; border-radius: 10px; word-wrap: break-word; }
.message.user { background: #667eea; text-align: right; margin-left: 20px; }
.message.grok { background: rgba(255,255,255,0.2); text-align: left; margin-right: 20px; border-left: 4px solid #4CAF50; }
.message-label { font-size: 12px; opacity: 0.7; margin-bottom: 5px; }
.controls { display: flex; gap: 15px; align-items: center; }
.btn-call { background: #4CAF50; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.btn-call:hover { background: #45a049; transform: scale(1.05); }
.btn-call.active { background: #ff4757; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,71,87,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,71,87,0); } }
.btn-end { background: #ff4757; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.btn-end:hover { background: #ff3838; }
.status-indicator { width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; animation: blink 2s infinite; }
.status-indicator.recording { background: #ff4757; }
@keyframes blink { 0%, 49%, 100% { opacity: 1; } 50%, 99% { opacity: 0.3; } }
.setup-screen { display: flex; flex-direction: column; align-items: center; gap: 20px; }
.hidden { display: none !important; }
</style>
</head>
<body>

<div class="call-container">
  <!-- Setup Screen -->
  <div id="setupScreen" class="setup-screen">
    <h1>Welcome to Aavaaz</h1>
    <p style="font-size: 18px; margin-bottom: 20px;">Live Voice Conversation with Grok AI</p>
    <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 15px; text-align: center;">
      <label style="font-size: 16px; margin-bottom: 15px; display: block;">Your Story/Context:</label>
      <textarea id="storyContext" placeholder="Tell us about your story so Grok understands better..." style="width: 100%; padding: 15px; border-radius: 8px; border: none; font-family: inherit; min-height: 120px; color: #333;"></textarea>
      <button onclick="startCall()" class="btn-call" style="margin-top: 20px; width: 100%;">Start Call</button>
    </div>
  </div>

  <!-- Call Screen -->
  <div id="callScreen" class="hidden">
    <div class="call-header">
      <h1 id="callerName">Speaking with Grok</h1>
      <div class="call-status" id="callStatus">Call Active</div>
    </div>
    
    <div class="call-info">
      <div class="call-timer" id="callTimer">00:00</div>
      <div style="font-size: 14px; opacity: 0.8;">Press and hold to speak, release to listen</div>
    </div>

    <!-- Waveform Animation -->
    <div class="waveform" id="waveform" style="display: none;">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    
    <!-- Conversation History -->
    <div class="conversation-box" id="conversationBox">
      <div style="text-align: center; color: rgba(255,255,255,0.5);">Conversation will appear here...</div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="status-indicator" id="statusIndicator"></div>
      <button id="recordBtn" class="btn-call" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">ðŸŽ¤ Hold to Speak</button>
      <button class="btn-end" onclick="endCall()">End Call</button>
    </div>
  </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let callActive = false;
let callStartTime = 0;
let recordingInProgress = false;
const conversationHistory = [];

async function startCall() {
  const context = document.getElementById('storyContext').value;
  if (!context.trim()) {
    alert('Please enter your story context');
    return;
  }
  
  // Request microphone access
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.onstart = () => {
      audioChunks = [];
      document.getElementById('waveform').style.display = 'flex';
      document.getElementById('statusIndicator').classList.add('recording');
      document.getElementById('callStatus').textContent = 'Recording...';
    };
    
    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      document.getElementById('waveform').style.display = 'none';
      document.getElementById('statusIndicator').classList.remove('recording');
      document.getElementById('callStatus').textContent = 'Call Active';
      
      // Send audio to backend API
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      await sendAudioToGrok(audioBlob, context);
    };
    
    // Start call
    callActive = true;
    callStartTime = Date.now();
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('callScreen').classList.remove('hidden');
    
    // Start timer
    startCallTimer();
    
    // Add initial message
    addMessage('System', 'Call started. Press and hold the microphone to speak.', 'grok');
  } catch (err) {
    alert('Microphone access denied: ' + err.message);
  }
}

function startRecording() {
  if (!callActive || recordingInProgress) return;
  recordingInProgress = true;
  audioChunks = [];
  mediaRecorder.start();
  document.getElementById('recordBtn').classList.add('active');
}

function stopRecording() {
  if (!recordingInProgress) return;
  recordingInProgress = false;
  mediaRecorder.stop();
  document.getElementById('recordBtn').classList.remove('active');
}

async function sendAudioToGrok(audioBlob, context) {
  try {
    const formData = new FormData();
    formData.append('audio', audioBlob);
    formData.append('context', context);
    formData.append('conversation', JSON.stringify(conversationHistory));
    
    // Add user message
    addMessage('You', '[Voice message sent]', 'user');
    document.getElementById('callStatus').textContent = 'Grok is thinking...';
    
    // Call backend API
    const response = await fetch('/api/conversation-loop', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    
    const data = await response.json();
    
    if (data.response) {
      addMessage('Grok', data.response, 'grok');
      conversationHistory.push({ user: '[Voice]', grok: data.response });
      
      // Play Grok's response as audio (if available)
      if (data.audio) {
        playAudio(data.audio);
      }
    }
    
    document.getElementById('callStatus').textContent = 'Call Active';
  } catch (err) {
    addMessage('System', 'Error: ' + err.message, 'grok');
    document.getElementById('callStatus').textContent = 'Call Active';
  }
}

function addMessage(sender, text, type) {
  const box = document.getElementById('conversationBox');
  const msg = document.createElement('div');
  msg.className = 'message ' + type;
  msg.innerHTML = '<div class="message-label">' + sender + '</div>' + text;
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}

function startCallTimer() {
  setInterval(() => {
    if (callActive) {
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('callTimer').textContent = 
        String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }
  }, 1000);
}

function playAudio(audioData) {
  // Decode and play audio response from Grok
  const audio = new Audio('data:audio/wav;base64,' + audioData);
  audio.play();
}

function endCall() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  callActive = false;
  document.getElementById('callScreen').classList.add('hidden');
  document.getElementById('setupScreen').classList.remove('hidden');
  document.getElementById('storyContext').value = '';
  conversationHistory.length = 0;
  document.getElementById('conversationBox').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5);">Conversation will appear here...</div>';
}
  
// Event listeners for hold-to-speak button
const recordBtn = document.getElementById('recordBtn');
if (recordBtn) {
  recordBtn.addEventListener('mousedown', startRecording);
  recordBtn.addEventListener('mouseup', stopRecording);
  recordBtn.addEventListener('mouseleave', stopRecording);
  recordBtn.addEventListener('touchstart', startRecording);
  recordBtn.addEventListener('touchend', stopRecording);
}
  
// After Grok response, automatically prompt for next input
setTimeout(() => {
  if (callActive) {
    document.getElementById('callStatus').textContent = 'Your turn - Press and hold to speak';
  }
}, 500);
</script>

</body>
</html>
